@{
    ViewBag.Title = "Gestión de Citas";
}

<h2 class="text-center mb-4">Gestión de Citas</h2>

<!-- Filtros -->
<div class="card p-4 mb-4 shadow-sm">
    <h5 class="font-weight-bold">Filtros de Búsqueda</h5>
    <div class="row">
        <div class="col-md-3">
            <label for="filtroMedico" class="font-weight-bold">Filtrar por Médico:</label>
            <select id="filtroMedico" class="form-control">
                <option value="">Todos</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="filtroEstado" class="font-weight-bold">Filtrar por Estado:</label>
            <select id="filtroEstado" class="form-control">
                <option value="">Todos</option>
                <option value="P">Pendiente</option>
                <option value="C">Confirmada</option>
                <option value="X">Cancelada</option>
            </select>
        </div>
        <div class="col-md-3">
            <label for="filtroFecha" class="font-weight-bold">Filtrar por Fecha:</label>
            <input type="date" id="filtroFecha" class="form-control" />
        </div>
        <div class="col-md-3">
            <label for="filtroEspecialidad" class="font-weight-bold">Filtrar por Especialidad:</label>
            <select id="filtroEspecialidad" class="form-control">
                <option value="">Todas</option>
            </select>
        </div>
    </div>
    <div class="row mt-3">
        <div class="col-md-6">
            <label for="codigoPacienteBuscar" class="font-weight-bold">Buscar por Código de Paciente:</label>
            <input type="text" id="codigoPacienteBuscar" class="form-control" placeholder="Ingrese el código del paciente" />
        </div>
        <div class="col-md-2 align-self-end">
            <button class="btn btn-primary w-100" id="btnBuscarCitas">Buscar</button>
        </div>
    </div>
</div>

<!-- Tabla -->
<div class="card p-4 shadow-sm">
    <h5 class="font-weight-bold">Listado de Citas</h5>
    <table id="tablaCitas" class="display table table-bordered table-hover" style="width:100%">
        <thead class="thead-dark">
            <tr>
                <th>Código</th>
                <th>Paciente</th>
                <th>Médico</th>
                <th>Especialidad</th>
                <th>Fecha y Hora</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
    </table>
    <div class="text-center mt-3">
        <button class="btn btn-success btn-sm" id="btnNuevaCita">Nueva Cita</button>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="modalCita" tabindex="-1" role="dialog" aria-labelledby="modalCitaLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalCitaLabel">Registrar Cita</h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formCita">
                    <div class="form-group">
                        <label for="dniPaciente" class="font-weight-bold">DNI del Paciente <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="text" id="dniPaciente" class="form-control" placeholder="Ingrese DNI" />
                            <div class="input-group-append">
                                <button class="btn btn-info" type="button" id="btnBuscarPaciente">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                        </div>
                        <small id="pacienteInfo" class="form-text text-muted"></small>
                    </div>
                    <div class="form-group">
                        <label for="medico" class="font-weight-bold">Médico <span class="text-danger">*</span></label>
                        <select id="medico" class="form-control">
                            <option value="">Seleccione un médico</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="especialidad" class="font-weight-bold">Especialidad <span class="text-danger">*</span></label>
                        <input type="text" id="especialidad" class="form-control" readonly />
                    </div>
                    <div class="form-group">
                        <label for="tipoConsulta" class="font-weight-bold">Tipo de Consulta <span class="text-danger">*</span></label>
                        <select id="tipoConsulta" class="form-control">
                            <option value="">Seleccione el tipo de consulta</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fechaHora" class="font-weight-bold">Fecha y Hora <span class="text-danger">*</span></label>
                        <input type="datetime-local" id="fechaHora" class="form-control" />
                    </div>
                    <div class="d-flex justify-content-end mt-4">
                        <button type="submit" class="btn btn-success mr-2">Guardar</button>
                        <button type="button" class="btn btn-secondary" id="btnCancelarModal" data-dismiss="modal">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- CSS de DataTables -->
<link rel="stylesheet" href="~/Scripts/DataTables/dataTables.bootstrap4.min.css">

@section Scripts {
    <!-- Scripts de DataTables -->
    <script src="~/Scripts/DataTables/jquery.dataTables.min.js"></script>
    <script src="~/Scripts/DataTables/dataTables.bootstrap4.min.js"></script>

    <script>
        $(document).ready(function () {
            const tablaCitas = $('#tablaCitas').DataTable({
                ajax: {
                    url: '@Url.Action("ObtenerCitasPorPaciente", "GestionarCitas")',
                    data: function (d) {
                        d.pacienteCodigo = $('#codigoPacienteBuscar').val(); // Enviar parámetro de búsqueda
                        d.medico = $('#filtroMedico').val(); // Filtro por médico
                        d.estado = $('#filtroEstado').val(); // Filtro por estado
                        d.fecha = $('#filtroFecha').val(); // Filtro por fecha
                        d.especialidad = $('#filtroEspecialidad').val(); // Filtro por especialidad
                    },
                    dataSrc: 'data',
                    error: function (xhr, error, thrown) {
                        console.log(xhr.responseText); // Log para depuración
                    }
                },
                columns: [
                    { data: 'citaCodigo' },
                    { data: 'citaPaciente.nombre' },
                    { data: 'citaMedico.nombre' },
                    { data: 'citaMedico.especialidad' },
                    { data: 'citaFechaHora', render: function (data) { return new Date(data).toLocaleString(); } },
                    {
                        data: 'citaEstado',
                        render: function (data) {
                            switch (data) {
                                case 'P': return 'Pendiente';
                                case 'C': return 'Confirmada';
                                case 'X': return 'Cancelada';
                                default: return 'Desconocido';
                            }
                        }
                    },
                    {
                        data: null,
                        render: function (data, type, row) {
                            return `<button class="btn btn-warning btn-sm btnEditar" data-id="${row.citaCodigo}">Editar</button>
                                    <button class="btn btn-danger btn-sm btnCancelar" data-id="${row.citaCodigo}">Cancelar</button>`;
                        }
                    }
                ],
                dom: 'rtip', 
            });

            // Evento para buscar citas con filtros
            $('#btnBuscarCitas').on('click', function () {
                tablaCitas.ajax.reload(); // Recargar tabla con los filtros aplicados
            });

            // Evento para actualizar la especialidad según el médico seleccionado
            $('#medico').on('change', function () {
                const medicoId = $(this).val();
                if (medicoId) {
                    $.ajax({
                        url: '@Url.Action("ObtenerEspecialidadPorMedico", "GestionarCitas")',
                        type: 'GET',
                        data: { medicoId },
                        success: function (data) {
                            if (data.consultaExitosa) {
                                $('#especialidad').val(data.especialidad);
                            } else {
                                alert('No se pudo obtener la especialidad del médico.');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Error al obtener la especialidad:', error);
                        }
                    });
                } else {
                    $('#especialidad').val('');
                }
            });

            // Evento para abrir el modal de "Nueva Cita"
            $('#btnNuevaCita').on('click', function () {
                $('#formCita')[0].reset();
                $('#pacienteInfo').text('');
                $('#modalCita').modal('show');
            });
        });
    </script>
}
